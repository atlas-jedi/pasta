{% block header_title %}Calculadora de Tempo{% endblock %}

<!-- Elemento escondido com o título do header para AJAX -->
<div data-header-title style="display: none;">Calculadora de Tempo</div>

{% block content %}
<div class="container py-3">
  <!-- Navigation tabs -->
  <ul class="nav nav-tabs" id="timeCalcTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if not calculation_type or calculation_type == 'add_subtract' %}active{% endif %}" 
              id="add-subtract-tab" data-bs-toggle="tab" data-bs-target="#add-subtract" 
              type="button" role="tab" aria-selected="true">
        <i class="bi bi-plus-slash-minus"></i> Adicionar/Subtrair
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if calculation_type == 'difference' %}active{% endif %}" 
              id="difference-tab" data-bs-toggle="tab" data-bs-target="#difference" 
              type="button" role="tab" aria-selected="false">
        <i class="bi bi-arrows-angle-expand"></i> Diferença
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if calculation_type == 'convert_units' %}active{% endif %}" 
              id="convert-tab" data-bs-toggle="tab" data-bs-target="#convert" 
              type="button" role="tab" aria-selected="false">
        <i class="bi bi-arrow-left-right"></i> Converter
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if calculation_type == 'divide_interval' %}active{% endif %}" 
              id="divide-tab" data-bs-toggle="tab" data-bs-target="#divide" 
              type="button" role="tab" aria-selected="false">
        <i class="bi bi-scissors"></i> Dividir Intervalo
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if calculation_type == 'timezone_convert' %}active{% endif %}" 
              id="timezone-tab" data-bs-toggle="tab" data-bs-target="#timezone" 
              type="button" role="tab" aria-selected="false">
        <i class="bi bi-globe"></i> Fusos Horários
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="timer-tab" data-bs-toggle="tab" data-bs-target="#timer" 
              type="button" role="tab" aria-selected="false">
        <i class="bi bi-alarm"></i> Timer
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="stopwatch-tab" data-bs-toggle="tab" data-bs-target="#stopwatch" 
              type="button" role="tab" aria-selected="false">
        <i class="bi bi-stopwatch"></i> Cronômetro
      </button>
    </li>
  </ul>
  
  <!-- Tab content -->
  <div class="tab-content bg-white p-4 border border-top-0 rounded-bottom" id="timeCalcTabContent">
    <!-- Add/Subtract Tab -->
    <div class="tab-pane fade {% if not calculation_type or calculation_type == 'add_subtract' %}show active{% endif %}" 
         id="add-subtract" role="tabpanel" aria-labelledby="add-subtract-tab">
      <h5 class="mb-3">Adicionar ou Subtrair Tempo</h5>
      <form action="{{ url_for('time_calculator.calculate') }}" method="post" class="row g-3 ajax-form">
        <input type="hidden" name="calculation_type" value="add_subtract">
        
        <div class="col-md-6">
          <label for="start_time" class="form-label">Hora Inicial (HH:MM)</label>
          <input type="text" class="form-control" id="start_time" name="start_time" 
                 placeholder="Ex: 14:30" value="{{ start_time|default('') }}">
        </div>
        
        <div class="col-md-6">
          <label for="operation" class="form-label">Operação</label>
          <select class="form-select" id="operation" name="operation">
            <option value="add" {% if operation == 'add' %}selected{% endif %}>Adicionar</option>
            <option value="subtract" {% if operation == 'subtract' %}selected{% endif %}>Subtrair</option>
          </select>
        </div>
        
        <div class="col-md-6">
          <label for="time_input" class="form-label">Quantidade</label>
          <input type="number" class="form-control" id="time_input" name="time_input" 
                 step="0.01" min="0" value="{{ time_input|default('0') }}">
        </div>
        
        <div class="col-md-6">
          <label for="time_unit" class="form-label">Unidade</label>
          <select class="form-select" id="time_unit" name="time_unit">
            <option value="seconds" {% if time_unit == 'seconds' %}selected{% endif %}>Segundos</option>
            <option value="minutes" {% if time_unit == 'minutes' %}selected{% endif %}>Minutos</option>
            <option value="hours" {% if time_unit == 'hours' or not time_unit %}selected{% endif %}>Horas</option>
            <option value="days" {% if time_unit == 'days' %}selected{% endif %}>Dias</option>
            <option value="weeks" {% if time_unit == 'weeks' %}selected{% endif %}>Semanas</option>
          </select>
        </div>
        
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Calcular</button>
        </div>
      </form>
      
      {% if result_time and calculation_type == 'add_subtract' %}
      <div class="mt-4 alert alert-success">
        <h5>Resultado:</h5>
        <p>A hora resultante é: <strong>{{ result_time }}</strong></p>
      </div>
      {% endif %}
    </div>
    
    <!-- Difference Tab -->
    <div class="tab-pane fade {% if calculation_type == 'difference' %}show active{% endif %}" 
         id="difference" role="tabpanel" aria-labelledby="difference-tab">
      <h5 class="mb-3">Calcular Diferença de Tempo</h5>
      <form action="{{ url_for('time_calculator.calculate') }}" method="post" class="row g-3 ajax-form">
        <input type="hidden" name="calculation_type" value="difference">
        
        <div class="col-12">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="include_date" name="include_date" 
                   value="true" {% if include_date %}checked{% endif %}>
            <label class="form-check-label" for="include_date">Incluir data</label>
          </div>
        </div>
        
        <div class="col-md-6" id="start_time_container">
          <label for="start_time_diff" class="form-label">
            {% if include_date %}Data e Hora Inicial (YYYY-MM-DD HH:MM){% else %}Hora Inicial (HH:MM){% endif %}
          </label>
          <input type="{% if include_date %}datetime-local{% else %}text{% endif %}" 
                 class="form-control" id="start_time_diff" name="start_time_diff" 
                 placeholder="{% if include_date %}2023-01-01 09:00{% else %}09:00{% endif %}" 
                 value="{{ start_time_diff|default('') }}">
        </div>
        
        <div class="col-md-6" id="end_time_container">
          <label for="end_time_diff" class="form-label">
            {% if include_date %}Data e Hora Final (YYYY-MM-DD HH:MM){% else %}Hora Final (HH:MM){% endif %}
          </label>
          <input type="{% if include_date %}datetime-local{% else %}text{% endif %}" 
                 class="form-control" id="end_time_diff" name="end_time_diff" 
                 placeholder="{% if include_date %}2023-01-02 17:30{% else %}17:30{% endif %}" 
                 value="{{ end_time_diff|default('') }}">
        </div>
        
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Calcular Diferença</button>
        </div>
      </form>
      
      {% if diff_hours is defined and diff_minutes is defined and calculation_type == 'difference' %}
      <div class="mt-4 alert alert-success">
        <h5>Resultado:</h5>
        <div class="row">
          <div class="col-md-6">
            <p class="mb-1">Formatado: <strong>{{ diff_hours }} horas, {{ diff_minutes }} minutos e {{ diff_seconds }} segundos</strong></p>
          </div>
          <div class="col-md-6">
            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Segundos
                <span class="badge bg-primary rounded-pill">{{ total_seconds }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Minutos
                <span class="badge bg-primary rounded-pill">{{ total_minutes }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Horas
                <span class="badge bg-primary rounded-pill">{{ total_hours }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Dias
                <span class="badge bg-primary rounded-pill">{{ total_days }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Semanas
                <span class="badge bg-primary rounded-pill">{{ total_weeks }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    
    <!-- Convert Tab -->
    <div class="tab-pane fade {% if calculation_type == 'convert_units' %}show active{% endif %}" 
         id="convert" role="tabpanel" aria-labelledby="convert-tab">
      <h5 class="mb-3">Converter Unidades de Tempo</h5>
      <form action="{{ url_for('time_calculator.calculate') }}" method="post" class="row g-3 ajax-form">
        <input type="hidden" name="calculation_type" value="convert_units">
        
        <div class="col-md-4">
          <label for="value" class="form-label">Valor</label>
          <input type="number" class="form-control" id="value" name="value" 
                 step="0.01" min="0" value="{{ value|default('0') }}">
        </div>
        
        <div class="col-md-4">
          <label for="from_unit" class="form-label">De</label>
          <select class="form-select" id="from_unit" name="from_unit">
            <option value="seconds" {% if from_unit == 'seconds' %}selected{% endif %}>Segundos</option>
            <option value="minutes" {% if from_unit == 'minutes' %}selected{% endif %}>Minutos</option>
            <option value="hours" {% if from_unit == 'hours' or not from_unit %}selected{% endif %}>Horas</option>
            <option value="days" {% if from_unit == 'days' %}selected{% endif %}>Dias</option>
            <option value="weeks" {% if from_unit == 'weeks' %}selected{% endif %}>Semanas</option>
            <option value="months" {% if from_unit == 'months' %}selected{% endif %}>Meses</option>
            <option value="years" {% if from_unit == 'years' %}selected{% endif %}>Anos</option>
          </select>
        </div>
        
        <div class="col-md-4">
          <label for="to_unit" class="form-label">Para</label>
          <select class="form-select" id="to_unit" name="to_unit">
            <option value="seconds" {% if to_unit == 'seconds' %}selected{% endif %}>Segundos</option>
            <option value="minutes" {% if to_unit == 'minutes' %}selected{% endif %}>Minutos</option>
            <option value="hours" {% if to_unit == 'hours' %}selected{% endif %}>Horas</option>
            <option value="days" {% if to_unit == 'days' or not to_unit %}selected{% endif %}>Dias</option>
            <option value="weeks" {% if to_unit == 'weeks' %}selected{% endif %}>Semanas</option>
            <option value="months" {% if to_unit == 'months' %}selected{% endif %}>Meses</option>
            <option value="years" {% if to_unit == 'years' %}selected{% endif %}>Anos</option>
          </select>
        </div>
        
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Converter</button>
        </div>
      </form>
      
      {% if result is defined and calculation_type == 'convert_units' %}
      <div class="mt-4 alert alert-success">
        <h5>Resultado:</h5>
        <p>{{ value }} {{ from_unit }} = <strong>{{ result }} {{ to_unit }}</strong></p>
      </div>
      {% endif %}
    </div>
    
    <!-- Divide Interval Tab -->
    <div class="tab-pane fade {% if calculation_type == 'divide_interval' %}show active{% endif %}" 
         id="divide" role="tabpanel" aria-labelledby="divide-tab">
      <h5 class="mb-3">Dividir Intervalo de Tempo</h5>
      <form action="{{ url_for('time_calculator.calculate') }}" method="post" class="row g-3 ajax-form">
        <input type="hidden" name="calculation_type" value="divide_interval">
        
        <div class="col-12">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="include_date_interval" 
                   name="include_date_interval" value="true" {% if include_date_interval %}checked{% endif %}>
            <label class="form-check-label" for="include_date_interval">Incluir data</label>
          </div>
        </div>
        
        <div class="col-md-5" id="start_interval_container">
          <label for="start_interval" class="form-label">
            {% if include_date_interval %}Data e Hora Inicial (YYYY-MM-DD HH:MM){% else %}Hora Inicial (HH:MM){% endif %}
          </label>
          <input type="{% if include_date_interval %}datetime-local{% else %}text{% endif %}" 
                 class="form-control" id="start_interval" name="start_interval" 
                 placeholder="{% if include_date_interval %}2023-01-01 09:00{% else %}09:00{% endif %}" 
                 value="{{ start_interval|default('') }}">
        </div>
        
        <div class="col-md-5" id="end_interval_container">
          <label for="end_interval" class="form-label">
            {% if include_date_interval %}Data e Hora Final (YYYY-MM-DD HH:MM){% else %}Hora Final (HH:MM){% endif %}
          </label>
          <input type="{% if include_date_interval %}datetime-local{% else %}text{% endif %}" 
                 class="form-control" id="end_interval" name="end_interval" 
                 placeholder="{% if include_date_interval %}2023-01-02 17:30{% else %}17:30{% endif %}" 
                 value="{{ end_interval|default('') }}">
        </div>
        
        <div class="col-md-2">
          <label for="divisions" class="form-label">Divisões</label>
          <input type="number" class="form-control" id="divisions" name="divisions" 
                 min="2" max="50" value="{{ divisions|default('2') }}">
        </div>
        
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Dividir Intervalo</button>
        </div>
      </form>
      
      {% if intervals is defined and calculation_type == 'divide_interval' %}
      <div class="mt-4 alert alert-success">
        <h5>Resultado:</h5>
        <p>Intervalo dividido em {{ divisions }} partes iguais de <strong>{{ division_duration }}</strong> cada:</p>
        <ol class="list-group list-group-numbered">
          {% for interval in intervals %}
            <li class="list-group-item">{{ interval }}</li>
          {% endfor %}
        </ol>
      </div>
      {% endif %}
    </div>
    
    <!-- Timezone Tab -->
    <div class="tab-pane fade {% if calculation_type == 'timezone_convert' %}show active{% endif %}" 
         id="timezone" role="tabpanel" aria-labelledby="timezone-tab">
      <h5 class="mb-3">Converter Fusos Horários</h5>
      <form action="{{ url_for('time_calculator.calculate') }}" method="post" class="row g-3 ajax-form">
        <input type="hidden" name="calculation_type" value="timezone_convert">
        
        <div class="col-md-6">
          <label for="source_time" class="form-label">Hora (HH:MM)</label>
          <input type="text" class="form-control" id="source_time" name="source_time" 
                 placeholder="Ex: 14:30" value="{{ source_time|default('') }}">
          <div class="form-text">Deixe em branco para usar a hora atual</div>
        </div>
        
        <div class="col-md-6">
          <label for="source_timezone" class="form-label">Fuso Horário de Origem</label>
          <select class="form-select" id="source_timezone" name="source_timezone">
            {% for tz in timezones %}
              <option value="{{ tz }}" {% if source_timezone == tz or (not source_timezone and tz == 'America/Sao_Paulo') %}selected{% endif %}>{{ tz }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-12">
          <label class="form-label">Fusos Horários de Destino</label>
          <div class="input-group mb-2">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="timezone-search" placeholder="Filtrar fusos horários...">
            <button type="button" class="btn btn-outline-secondary" id="clear-timezone-search">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted" id="timezone-counter"></small>
            <small class="text-muted">Segure Ctrl para selecionar múltiplos fusos horários</small>
          </div>
          <select class="form-select" id="target_timezones" name="target_timezones[]" multiple size="6">
            {% for tz in timezones %}
              <option value="{{ tz }}" {% if target_timezones and tz in target_timezones %}selected{% endif %}>{{ tz }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Converter</button>
        </div>
      </form>
      
      {% if conversions is defined and calculation_type == 'timezone_convert' %}
      <div class="mt-4 alert alert-success">
        <h5>Resultado:</h5>
        <p>Hora em {{ source_timezone }}: <strong>{{ source_time }}</strong></p>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Fuso Horário</th>
                <th>Hora</th>
                <th>Horário de Verão</th>
              </tr>
            </thead>
            <tbody>
              {% for conv in conversions %}
                <tr>
                  <td>{{ conv.timezone }}</td>
                  <td>{{ conv.time }}</td>
                  <td>{% if conv.dst_active %}<i class="bi bi-check text-success"></i>{% else %}<i class="bi bi-x text-danger"></i>{% endif %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
    
    <!-- Timer Tab -->
    <div class="tab-pane fade" id="timer" role="tabpanel" aria-labelledby="timer-tab">
      <div class="text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p>Carregando Timer...</p>
      </div>
    </div>
    
    <!-- Stopwatch Tab -->
    <div class="tab-pane fade" id="stopwatch" role="tabpanel" aria-labelledby="stopwatch-tab">
      <div class="text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p>Carregando Cronômetro...</p>
      </div>
    </div>
  </div>
  
  {% if error %}
  <div class="mt-4 alert alert-danger">
    <p>{{ error }}</p>
  </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Date inclusion toggle for difference calculation
    const includeDateCheckbox = document.getElementById('include_date');
    if (includeDateCheckbox) {
      includeDateCheckbox.addEventListener('change', function() {
        updateDateTimeInputs('start_time_diff', 'end_time_diff', this.checked);
      });
    }
    
    // Date inclusion toggle for interval division
    const includeDateIntervalCheckbox = document.getElementById('include_date_interval');
    if (includeDateIntervalCheckbox) {
      includeDateIntervalCheckbox.addEventListener('change', function() {
        updateDateTimeInputs('start_interval', 'end_interval', this.checked);
      });
    }
    
    // Function to update datetime inputs based on checkbox state
    function updateDateTimeInputs(startId, endId, includeDate) {
      const startInput = document.getElementById(startId);
      const endInput = document.getElementById(endId);
      const startLabel = startInput.previousElementSibling;
      const endLabel = endInput.previousElementSibling;
      
      if (includeDate) {
        startInput.type = 'datetime-local';
        endInput.type = 'datetime-local';
        startLabel.textContent = 'Data e Hora Inicial (YYYY-MM-DD HH:MM)';
        endLabel.textContent = 'Data e Hora Final (YYYY-MM-DD HH:MM)';
        startInput.placeholder = '2023-01-01 09:00';
        endInput.placeholder = '2023-01-02 17:30';
      } else {
        startInput.type = 'text';
        endInput.type = 'text';
        startLabel.textContent = 'Hora Inicial (HH:MM)';
        endLabel.textContent = 'Hora Final (HH:MM)';
        startInput.placeholder = '09:00';
        endInput.placeholder = '17:30';
      }
    }
    
    // Timezone search functionality
    const timezoneSearchInput = document.getElementById('timezone-search');
    const clearTimezoneSearchBtn = document.getElementById('clear-timezone-search');
    const targetTimezonesSelect = document.getElementById('target_timezones');
    const timezoneCounter = document.getElementById('timezone-counter');
    
    if (timezoneSearchInput && targetTimezonesSelect) {
      // Armazenar todos os fusos horários originais para referência
      const allTimezones = [];
      const selectedTimezones = new Set();
      
      // Inicializar o array com todos os fusos horários e status de seleção
      for (let i = 0; i < targetTimezonesSelect.options.length; i++) {
        const option = targetTimezonesSelect.options[i];
        allTimezones.push({
          value: option.value,
          text: option.text,
          selected: option.selected
        });
        
        if (option.selected) {
          selectedTimezones.add(option.value);
        }
      }
      
      // Atualizar contador inicialmente
      updateTimezoneCounter(allTimezones.length, allTimezones.length);
      
      // Função para atualizar a lista de fusos com base no filtro
      function updateTimezoneList(filter = '') {
        // Limpar o select atual
        targetTimezonesSelect.innerHTML = '';
        
        // Filtrar os fusos horários
        const filteredTimezones = filter === '' 
          ? allTimezones 
          : allTimezones.filter(tz => tz.text.toLowerCase().includes(filter.toLowerCase()));
        
        // Adicionar as opções filtradas
        filteredTimezones.forEach(tz => {
          const option = document.createElement('option');
          option.value = tz.value;
          option.text = tz.text;
          option.selected = selectedTimezones.has(tz.value);
          targetTimezonesSelect.appendChild(option);
        });
        
        // Mostrar feedback se não houver resultados
        if (filteredTimezones.length === 0) {
          const noResults = document.createElement('option');
          noResults.disabled = true;
          noResults.text = 'Nenhum fuso horário encontrado';
          targetTimezonesSelect.appendChild(noResults);
        }
        
        // Atualizar contador de resultados
        updateTimezoneCounter(filteredTimezones.length, allTimezones.length);
      }
      
      // Função para atualizar o contador de resultados
      function updateTimezoneCounter(count, total) {
        if (timezoneCounter) {
          if (count === total) {
            timezoneCounter.textContent = `Exibindo todos os ${total} fusos horários`;
          } else {
            timezoneCounter.textContent = `Exibindo ${count} de ${total} fusos horários`;
          }
        }
      }
      
      // Evento para atualizar seleções
      targetTimezonesSelect.addEventListener('change', function() {
        // Atualizar o conjunto de fusos selecionados
        selectedTimezones.clear();
        for (let i = 0; i < this.options.length; i++) {
          if (this.options[i].selected) {
            selectedTimezones.add(this.options[i].value);
          }
        }
      });
      
      // Evento de busca
      timezoneSearchInput.addEventListener('input', function() {
        updateTimezoneList(this.value);
      });
      
      // Clear search button
      clearTimezoneSearchBtn.addEventListener('click', function() {
        timezoneSearchInput.value = '';
        updateTimezoneList('');
        timezoneSearchInput.focus();
      });
    }
    
    // Load timer content
    const timerTab = document.getElementById('timer-tab');
    if (timerTab) {
      timerTab.addEventListener('shown.bs.tab', function() {
        const timerPane = document.getElementById('timer');
        fetch("{{ url_for('time_calculator.timer') }}", {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          console.log('Timer content loaded successfully');
          
          // Cria um elemento temporário para extrair o script sem executá-lo
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;
          
          // Encontra todos os scripts antes de inserir o HTML
          const scripts = Array.from(tempDiv.querySelectorAll('script')).map(script => {
            // Armazena o conteúdo e remove o script do HTML
            const content = script.textContent;
            const src = script.src;
            script.remove();
            return { content, src };
          });
          
          // Insere o HTML sem os scripts
          timerPane.innerHTML = tempDiv.innerHTML;
          
          // Executa cada script após o HTML estar carregado
          scripts.forEach(scriptData => {
            try {
              if (scriptData.src) {
                // Script externo
                const script = document.createElement('script');
                script.src = scriptData.src;
                document.body.appendChild(script);
              } else if (scriptData.content) {
                // Script inline
                const modifiedContent = scriptData.content
                  // Remove evento DOMContentLoaded e executa o código diretamente
                  .replace(/document\.addEventListener\(['"]DOMContentLoaded['"], function\(\) \{([\s\S]*)\}\);/, function(match, p1) {
                    return p1;
                  });
                  
                // Executa o script modificado
                const script = document.createElement('script');
                script.textContent = `
                  try {
                    ${modifiedContent}
                  } catch(e) { 
                    console.error('Erro ao executar script do timer:', e);
                  }
                `;
                document.body.appendChild(script);
                // Script inline pode ser removido após execução
                document.body.removeChild(script);
              }
            } catch (error) {
              console.error('Erro ao processar script:', error);
            }
          });
          
          console.log('Timer scripts executed');
        })
        .catch(error => {
          console.error('Erro ao carregar timer:', error);
          timerPane.innerHTML = `
            <div class="alert alert-danger">
              <h5>Erro ao carregar o Timer</h5>
              <p>Detalhes do erro: ${error.message}</p>
              <button class="btn btn-primary" onclick="location.reload()">Recarregar Página</button>
            </div>`;
        });
      });
    }
    
    // Load stopwatch content
    const stopwatchTab = document.getElementById('stopwatch-tab');
    if (stopwatchTab) {
      stopwatchTab.addEventListener('shown.bs.tab', function() {
        const stopwatchPane = document.getElementById('stopwatch');
        fetch("{{ url_for('time_calculator.stopwatch') }}", {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          console.log('Stopwatch content loaded successfully');
          
          // Cria um elemento temporário para extrair o script sem executá-lo
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;
          
          // Encontra todos os scripts antes de inserir o HTML
          const scripts = Array.from(tempDiv.querySelectorAll('script')).map(script => {
            // Armazena o conteúdo e remove o script do HTML
            const content = script.textContent;
            const src = script.src;
            script.remove();
            return { content, src };
          });
          
          // Insere o HTML sem os scripts
          stopwatchPane.innerHTML = tempDiv.innerHTML;
          
          // Executa cada script após o HTML estar carregado
          scripts.forEach(scriptData => {
            try {
              if (scriptData.src) {
                // Script externo
                const script = document.createElement('script');
                script.src = scriptData.src;
                document.body.appendChild(script);
              } else if (scriptData.content) {
                // Script inline
                const modifiedContent = scriptData.content
                  // Remove evento DOMContentLoaded e executa o código diretamente
                  .replace(/document\.addEventListener\(['"]DOMContentLoaded['"], function\(\) \{([\s\S]*)\}\);/, function(match, p1) {
                    return p1;
                  });
                  
                // Executa o script modificado
                const script = document.createElement('script');
                script.textContent = `
                  try {
                    ${modifiedContent}
                  } catch(e) { 
                    console.error('Erro ao executar script do stopwatch:', e);
                  }
                `;
                document.body.appendChild(script);
                // Script inline pode ser removido após execução
                document.body.removeChild(script);
              }
            } catch (error) {
              console.error('Erro ao processar script do stopwatch:', error);
            }
          });
          
          console.log('Stopwatch scripts executed');
        })
        .catch(error => {
          console.error('Erro ao carregar stopwatch:', error);
          stopwatchPane.innerHTML = `
            <div class="alert alert-danger">
              <h5>Erro ao carregar o Cronômetro</h5>
              <p>Detalhes do erro: ${error.message}</p>
              <button class="btn btn-primary" onclick="location.reload()">Recarregar Página</button>
            </div>`;
        });
      });
    }
    
    // Manipulador de formulários para envio via AJAX
    document.querySelectorAll('.ajax-form').forEach(function(form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault(); // Previne o envio normal do formulário
        
        const formData = new FormData(this);
        // Adicionar parâmetro para solicitar resposta JSON
        formData.append('format', 'json');
        
        const calculationType = formData.get('calculation_type');
        const tabId = this.closest('.tab-pane').id;
        const resultContainer = this.nextElementSibling;
        
        // Adicionar indicador de carregamento
        let loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'text-center mt-3';
        loadingIndicator.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Calculando...</p>';
        
        // Se já existe um resultado, substituí-lo pelo indicador de carregamento
        if (resultContainer && resultContainer.classList.contains('alert')) {
          resultContainer.replaceWith(loadingIndicator);
        } else {
          // Caso contrário, adicionar o indicador após o formulário
          this.insertAdjacentElement('afterend', loadingIndicator);
        }
        
        // Enviar solicitação AJAX
        axios.post(this.action, formData)
          .then(response => {
            // Verificar se a resposta é JSON
            const data = response.data;
            
            // Criar o elemento de resultado com base no tipo de cálculo
            let resultHTML = '';
            
            if (data.error) {
              resultHTML = `
                <div class="mt-4 alert alert-danger">
                  <p>${data.error}</p>
                </div>
              `;
            } else {
              switch(calculationType) {
                case 'add_subtract':
                  resultHTML = `
                    <div class="mt-4 alert alert-success">
                      <h5>Resultado:</h5>
                      <p>A hora resultante é: <strong>${data.result_time}</strong></p>
                    </div>
                  `;
                  break;
                case 'difference':
                  resultHTML = `
                    <div class="mt-4 alert alert-success">
                      <h5>Resultado:</h5>
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1">Formatado: <strong>${data.diff_hours} horas, ${data.diff_minutes} minutos e ${data.diff_seconds} segundos</strong></p>
                        </div>
                        <div class="col-md-6">
                          <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              Segundos
                              <span class="badge bg-primary rounded-pill">${data.total_seconds}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              Minutos
                              <span class="badge bg-primary rounded-pill">${data.total_minutes}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              Horas
                              <span class="badge bg-primary rounded-pill">${data.total_hours}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              Dias
                              <span class="badge bg-primary rounded-pill">${data.total_days}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              Semanas
                              <span class="badge bg-primary rounded-pill">${data.total_weeks}</span>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  `;
                  break;
                case 'convert_units':
                  resultHTML = `
                    <div class="mt-4 alert alert-success">
                      <h5>Resultado:</h5>
                      <p>${data.value} ${data.from_unit} = <strong>${data.result} ${data.to_unit}</strong></p>
                    </div>
                  `;
                  break;
                case 'divide_interval':
                  const intervalItems = data.intervals.map((interval, idx) => 
                    `<li class="list-group-item">${interval}</li>`
                  ).join('');
                  
                  resultHTML = `
                    <div class="mt-4 alert alert-success">
                      <h5>Resultado:</h5>
                      <p>Intervalo dividido em ${data.divisions} partes iguais de <strong>${data.division_duration}</strong> cada:</p>
                      <ol class="list-group list-group-numbered">
                        ${intervalItems}
                      </ol>
                    </div>
                  `;
                  break;
                case 'timezone_convert':
                  const conversionRows = data.conversions.map(conv => `
                    <tr>
                      <td>${conv.timezone}</td>
                      <td>${conv.time}</td>
                      <td>${conv.dst_active ? '<i class="bi bi-check text-success"></i>' : '<i class="bi bi-x text-danger"></i>'}</td>
                    </tr>
                  `).join('');
                  
                  resultHTML = `
                    <div class="mt-4 alert alert-success">
                      <h5>Resultado:</h5>
                      <p>Hora em ${data.source_timezone}: <strong>${data.source_time}</strong></p>
                      <div class="table-responsive">
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Fuso Horário</th>
                              <th>Hora</th>
                              <th>Horário de Verão</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${conversionRows}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  `;
                  break;
              }
            }
            
            // Criar elemento DOM a partir do HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = resultHTML;
            const resultElement = tempDiv.firstElementChild;
            
            // Substituir o indicador de carregamento pelo resultado
            if (resultElement) {
              loadingIndicator.replaceWith(resultElement);
            } else {
              loadingIndicator.innerHTML = '<div class="alert alert-danger mt-3">Não foi possível processar o resultado.</div>';
            }
          })
          .catch(function(error) {
            console.error('Erro ao calcular:', error);
            loadingIndicator.innerHTML = '<div class="alert alert-danger mt-3">Ocorreu um erro ao processar a solicitação.</div>';
          });
      });
    });
  });
</script>
{% endblock %} 