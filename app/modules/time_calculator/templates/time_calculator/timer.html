<div class="timer-container">
  <h5 class="mb-3">Timer</h5>
  
  <!-- Timer Display -->
  <div class="timer-display mb-4 text-center">
    <div class="row">
      <div class="col-md-8 offset-md-2">
        <div class="card">
          <div class="card-body p-4">
            <div class="display-1 timer-countdown mb-3">
              <span id="hours">00</span>:<span id="minutes">00</span>:<span id="seconds">00</span>
            </div>
            <div class="progress mb-4">
              <div id="timer-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-center">
              <button id="start-timer-btn" class="btn btn-primary mx-1">
                <i class="bi bi-play-fill"></i> Iniciar
              </button>
              <button id="pause-timer-btn" class="btn btn-warning mx-1" disabled>
                <i class="bi bi-pause-fill"></i> Pausar
              </button>
              <button id="reset-timer-btn" class="btn btn-danger mx-1" disabled>
                <i class="bi bi-arrow-counterclockwise"></i> Reiniciar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Timer Settings -->
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">Configurar Timer</h6>
        </div>
        <div class="card-body">
          <form id="timer-form" class="row g-3">
            <div class="col-4">
              <label for="timer-hours" class="form-label">Horas</label>
              <input type="number" class="form-control" id="timer-hours" min="0" max="23" value="0">
            </div>
            <div class="col-4">
              <label for="timer-minutes" class="form-label">Minutos</label>
              <input type="number" class="form-control" id="timer-minutes" min="0" max="59" value="0">
            </div>
            <div class="col-4">
              <label for="timer-seconds" class="form-label">Segundos</label>
              <input type="number" class="form-control" id="timer-seconds" min="0" max="59" value="0">
            </div>
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="timer-loop" value="1">
                <label class="form-check-label" for="timer-loop">Repetir automaticamente</label>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">Notificações</h6>
        </div>
        <div class="card-body">
          <form id="notification-form" class="row g-3">
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="enable-sound" value="1" checked>
                <label class="form-check-label" for="enable-sound">Som de alerta</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="enable-browser-notification" value="1">
                <label class="form-check-label" for="enable-browser-notification">Notificação do navegador</label>
              </div>
            </div>
            <div class="col-12">
              <label for="notification-message" class="form-label">Mensagem de notificação</label>
              <input type="text" class="form-control" id="notification-message" value="Tempo esgotado!">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Presets -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Presets</h6>
      <button id="save-preset-btn" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-save"></i> Salvar Preset
      </button>
    </div>
    <div class="card-body">
      <div class="row" id="preset-container">
        <div class="col-md-3 mb-2">
          <div class="card preset-card">
            <div class="card-body text-center">
              <h6>Pomodoro</h6>
              <p class="mb-0">25:00</p>
              <button class="btn btn-sm btn-outline-secondary mt-2 load-preset" data-hours="0" data-minutes="25" data-seconds="0">
                Carregar
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card preset-card">
            <div class="card-body text-center">
              <h6>Pausa Curta</h6>
              <p class="mb-0">05:00</p>
              <button class="btn btn-sm btn-outline-secondary mt-2 load-preset" data-hours="0" data-minutes="5" data-seconds="0">
                Carregar
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card preset-card">
            <div class="card-body text-center">
              <h6>Pausa Longa</h6>
              <p class="mb-0">15:00</p>
              <button class="btn btn-sm btn-outline-secondary mt-2 load-preset" data-hours="0" data-minutes="15" data-seconds="0">
                Carregar
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-2">
          <div class="card preset-card">
            <div class="card-body text-center">
              <h6>Reunião</h6>
              <p class="mb-0">01:00:00</p>
              <button class="btn btn-sm btn-outline-secondary mt-2 load-preset" data-hours="1" data-minutes="0" data-seconds="0">
                Carregar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sound for timer -->
<audio id="timer-sound" preload="auto">
  <source src="https://assets.mixkit.co/active_storage/sfx/988/988-preview.mp3" type="audio/mpeg">
  <!-- Backup de áudio embutido como base64 caso a URL externa falhe -->
  <source src="data:audio/mp3;base64,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" type="audio/mp3">
</audio>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Timer elements
    const hoursElement = document.getElementById('hours');
    const minutesElement = document.getElementById('minutes');
    const secondsElement = document.getElementById('seconds');
    const progressBar = document.getElementById('timer-progress');
    
    // Buttons
    const startBtn = document.getElementById('start-timer-btn');
    const pauseBtn = document.getElementById('pause-timer-btn');
    const resetBtn = document.getElementById('reset-timer-btn');
    
    // Form inputs
    const hoursInput = document.getElementById('timer-hours');
    const minutesInput = document.getElementById('timer-minutes');
    const secondsInput = document.getElementById('timer-seconds');
    const loopCheckbox = document.getElementById('timer-loop');
    
    // Notification elements
    const soundCheckbox = document.getElementById('enable-sound');
    const notificationCheckbox = document.getElementById('enable-browser-notification');
    const notificationMessage = document.getElementById('notification-message');
    
    // Sound element
    const timerSound = document.getElementById('timer-sound');
    
    // Timer variables
    let timer = null;
    let totalSeconds = 0;
    let remainingSeconds = 0;
    let isRunning = false;
    let originalSeconds = 0;
    
    // Load preset buttons
    const presetButtons = document.querySelectorAll('.load-preset');
    presetButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const hours = parseInt(this.dataset.hours);
        const minutes = parseInt(this.dataset.minutes);
        const seconds = parseInt(this.dataset.seconds);
        
        hoursInput.value = hours;
        minutesInput.value = minutes;
        secondsInput.value = seconds;
        
        updateTimerDisplay(hours, minutes, seconds);
        resetTimer();
      });
    });
    
    // Initialize
    updateTimerDisplay(0, 0, 0);
    
    // Event listeners
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);
    
    // Request permission for browser notifications
    if ('Notification' in window) {
      notificationCheckbox.addEventListener('change', function() {
        if (this.checked) {
          Notification.requestPermission();
        }
      });
    } else {
      notificationCheckbox.disabled = true;
      notificationCheckbox.parentElement.style.opacity = 0.5;
    }
    
    // Functions
    function startTimer() {
      if (!isRunning) {
        // Get values from inputs if timer is not already set
        if (remainingSeconds === 0) {
          const hours = parseInt(hoursInput.value) || 0;
          const minutes = parseInt(minutesInput.value) || 0;
          const seconds = parseInt(secondsInput.value) || 0;
          
          totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
          remainingSeconds = totalSeconds;
          originalSeconds = totalSeconds;
          
          // Validate if timer has a valid duration
          if (totalSeconds <= 0) {
            alert('Por favor, defina um tempo maior que zero.');
            return;
          }
        }
        
        isRunning = true;
        startBtn.disabled = true;
        pauseBtn.disabled = false;
        resetBtn.disabled = false;
        
        timer = setInterval(function() {
          remainingSeconds--;
          
          // Update progress bar
          const progress = ((originalSeconds - remainingSeconds) / originalSeconds) * 100;
          progressBar.style.width = `${progress}%`;
          
          // Calculate hours, minutes and seconds
          const hours = Math.floor(remainingSeconds / 3600);
          const minutes = Math.floor((remainingSeconds % 3600) / 60);
          const seconds = remainingSeconds % 60;
          
          // Update display
          updateTimerDisplay(hours, minutes, seconds);
          
          // Check if timer reached zero
          if (remainingSeconds <= 0) {
            clearInterval(timer);
            isRunning = false;
            
            // Play sound if enabled
            if (soundCheckbox.checked) {
              playTimerSound();
            }
            
            // Show browser notification if enabled
            if (notificationCheckbox.checked && 'Notification' in window && Notification.permission === 'granted') {
              new Notification('Timer', {
                body: notificationMessage.value,
                icon: '/static/images/timer-icon.png'
              });
            }
            
            // If loop is enabled, restart timer
            if (loopCheckbox.checked) {
              remainingSeconds = originalSeconds;
              startTimer();
            } else {
              startBtn.disabled = false;
              pauseBtn.disabled = true;
            }
          }
        }, 1000);
      }
    }
    
    function pauseTimer() {
      if (isRunning) {
        clearInterval(timer);
        isRunning = false;
        startBtn.disabled = false;
        pauseBtn.disabled = true;
      }
    }
    
    function resetTimer() {
      clearInterval(timer);
      isRunning = false;
      
      const hours = parseInt(hoursInput.value) || 0;
      const minutes = parseInt(minutesInput.value) || 0;
      const seconds = parseInt(secondsInput.value) || 0;
      
      totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
      remainingSeconds = totalSeconds;
      originalSeconds = totalSeconds;
      
      updateTimerDisplay(hours, minutes, seconds);
      progressBar.style.width = '0%';
      
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resetBtn.disabled = true;
    }
    
    function updateTimerDisplay(hours, minutes, seconds) {
      hoursElement.textContent = hours.toString().padStart(2, '0');
      minutesElement.textContent = minutes.toString().padStart(2, '0');
      secondsElement.textContent = seconds.toString().padStart(2, '0');
    }
    
    // Save preset functionality
    document.getElementById('save-preset-btn').addEventListener('click', function() {
      const hours = parseInt(hoursInput.value) || 0;
      const minutes = parseInt(minutesInput.value) || 0;
      const seconds = parseInt(secondsInput.value) || 0;
      
      if (hours === 0 && minutes === 0 && seconds === 0) {
        alert('Por favor, defina um tempo maior que zero para salvar como preset.');
        return;
      }
      
      const presetName = prompt('Digite um nome para o preset:');
      if (presetName) {
        // Format time for display
        const timeDisplay = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Create preset card
        const presetCard = document.createElement('div');
        presetCard.className = 'col-md-3 mb-2';
        presetCard.innerHTML = `
          <div class="card preset-card">
            <div class="card-body text-center">
              <h6>${presetName}</h6>
              <p class="mb-0">${timeDisplay}</p>
              <button class="btn btn-sm btn-outline-secondary mt-2 load-preset" data-hours="${hours}" data-minutes="${minutes}" data-seconds="${seconds}">
                Carregar
              </button>
            </div>
          </div>
        `;
        
        // Add to container
        document.getElementById('preset-container').appendChild(presetCard);
        
        // Add event listener to the new button
        const newButton = presetCard.querySelector('.load-preset');
        newButton.addEventListener('click', function() {
          hoursInput.value = this.dataset.hours;
          minutesInput.value = this.dataset.minutes;
          secondsInput.value = this.dataset.seconds;
          
          updateTimerDisplay(parseInt(this.dataset.hours), parseInt(this.dataset.minutes), parseInt(this.dataset.seconds));
          resetTimer();
        });
      }
    });
    
    // Play sound function - improved to handle compatibility issues
    function playTimerSound() {
      try {
        const timerSound = document.getElementById('timer-sound');
        
        // Reset the sound to the beginning
        timerSound.currentTime = 0;
        
        // Try to play the sound
        const playPromise = timerSound.play();
        
        // Handle potential promise rejection (browsers may require user interaction)
        if (playPromise !== undefined) {
          playPromise.then(() => {
            console.log('Timer sound played successfully');
          }).catch(error => {
            console.warn('Auto-play prevented:', error);
            // Alert the user about the timer completion even if sound fails
            alert('Timer concluído! (Som desativado devido às configurações do navegador)');
          });
        }
      } catch (error) {
        console.error('Error playing timer sound:', error);
      }
    }
  });
</script> 